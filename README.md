# Simple Image Click

PyAutoGUIを使用した画像認識ベースのクリック自動化ツール。ブラウザUIで直感的に操作できます。

## 開発経緯

### 背景・課題

定型的な画面操作を自動化したいが、以下の課題があった：

1. **毎回画像ファイル名を入力するのが面倒** - コマンドラインで画像名を指定する方式は非効率
2. **操作順序の管理が複雑** - 複数の操作を組み合わせる場合、順番を覚えておく必要がある
3. **繰り返し使いたい** - 週次作業など、同じフローを何度も使い回したい

### 設計思想

1. **ブラウザUIで視覚的に操作** - 画像をクリックするだけでアクションを追加
2. **フロー保存機能** - 一度組んだアクションを名前をつけて保存、後から呼び出し
3. **テキストID参照** - テキストを編集しても、それを使うフローすべてに反映される

### 技術選定

- **FastAPI** - 軽量・高速なPython Webフレームワーク（Flask より現代的）
- **PyAutoGUI** - クロスプラットフォームの画面操作ライブラリ
- **pyperclip** - クリップボード操作（テキスト貼り付け用）
- **Vanilla JS** - フロントエンドはフレームワーク不要でシンプルに

## 機能

### 基本機能

| 機能 | 説明 |
|------|------|
| 画像クリック | 画面上の画像を認識してクリック |
| 画像待機 | 指定した画像が表示されるまで待機（カーソルが動いて待機中を表示） |
| テキスト貼り付け | 登録したテキストをCtrl+Vで貼り付け |
| フロー保存 | 複数アクションを名前をつけて保存、後から呼び出し |
| フロー休止 | 使わないフローを一時的に無効化 |

### フロー休止機能

- **⏸️ボタン** - フロー一覧の各フローに休止/再開ボタンを表示
- **グレーアウト** - 休止中のフローは薄く表示され、フロー名に取り消し線
- **チェック不可** - 休止中フローはチェックボックスが無効化
- **まとめてチェック除外** - 「☑ まとめてチェック」で休止中は選択されない
- **▶️で再開** - 休止中のフローは▶️ボタンで再開可能

### テキスト管理

- **8桁ユニークID** - 各テキストに固有IDが振られる
- **ID参照** - フローはテキストをIDで参照するため、テキスト編集が全フローに反映
- **AND検索** - スペース区切りで複数キーワード検索（例: `報告 週次`）

## インストール

```bash
pip install -r requirements.txt
```

## 使い方

### 1. サーバー起動

```bash
python main.py
```

### 2. ブラウザでアクセス

http://localhost:8000 を開く

### 3. 画像をアップロード

- ドラッグ＆ドロップ
- ファイル選択
- Ctrl+V（Snipping Toolなどからの貼り付け）

### 4. アクションを追加

1. **画像をクリック** → クリック or 待機アクション追加（モード切替で選択）
2. **テキストをクリック** → 貼り付けアクション追加

### 5. 実行

「▶ 実行」ボタンで順番に実行

### 6. フロー保存（オプション）

「💾 保存」でフロー名をつけて保存。次回は「読込」で呼び出し。

## 設定項目

| 項目 | 説明 | デフォルト |
|------|------|-----------:|
| アクション間隔 | 各アクション間の待機時間 | 2秒 |
| 認識精度 | 画像認識の閾値 (0.0-1.0) | 0.95 |
| 最低精度 | 段階的に下げる最低閾値 | 0.7 |
| 待機タイムアウト | 画像待機の最大時間 | 1800秒 |
| カーソル速度 | 待機中のカーソル移動速度 | 0.5秒 |
| 開始前待機 | 最初のアクション前の待機時間 | 0秒 |

## アーキテクチャ

```
simple-image-click/
├── main.py          # FastAPIサーバー・PyAutoGUI実行ロジック
├── index.html       # ブラウザUI（HTML/CSS/JS一体型）
├── requirements.txt # Python依存パッケージ
├── images/          # アップロードされた画像（.gitignore対象）
├── texts.json       # テキストデータ（ID付き、.gitignore対象）
└── flows.json       # フローデータ（.gitignore対象）
```

### データ構造

**texts.json** (ID付き辞書形式)
```json
{
  "12345678": {
    "id": "12345678",
    "text": "貼り付けるテキスト内容",
    "created_at": "2024-12-11 15:30:00"
  }
}
```

**flows.json**
```json
{
  "週次報告書作成": {
    "actions": [
      {"type": "click", "image_name": "start_button.png"},
      {"type": "wait", "image_name": "dialog.png"},
      {"type": "paste", "text_id": "12345678"}
    ],
    "created_at": "2024-12-11 15:30:00"
  }
}
```

### API一覧

| Method | Endpoint | 説明 |
|--------|----------|------|
| GET | `/api/images` | 画像一覧 |
| POST | `/api/upload` | 画像アップロード |
| DELETE | `/api/images/{name}` | 画像削除 |
| GET | `/api/texts` | テキスト一覧 |
| POST | `/api/texts` | テキスト追加 |
| PUT | `/api/texts/{id}` | テキスト更新 |
| DELETE | `/api/texts/{id}` | テキスト削除 |
| GET | `/api/flows` | フロー一覧 |
| POST | `/api/flows` | フロー保存 |
| DELETE | `/api/flows/{name}` | フロー削除 |
| POST | `/api/execute` | アクション実行 |

## 注意事項

- **マルチモニター環境**: 各モニターのスケーリング（拡大率）を揃えることを推奨
- **フェイルセーフ**: 画面左上にマウスを移動すると強制停止（PyAutoGUI標準機能）
- **テキスト削除時**: フローは該当テキストIDへの参照を維持。実行時に「見つかりません」エラー

## トラブルシューティング

### Pythonプロセスの強制終了

待機処理中にマウスが動き続けて止まらない場合、Pythonプロセスを強制終了する必要がある。

**❌ 間違ったチェック方法（信頼性が低い）:**
```bash
cmd.exe /c "tasklist | findstr python"
# → 出力が正しく取れない場合があり、プロセスが残っていても空になることがある
```

**✅ 正しいチェック方法:**
```bash
wmic process where "name like '%python%'" get processid,name,commandline
# → 確実にPythonプロセスを一覧表示できる
```

**強制終了方法:**
```bash
# PIDを指定して終了（上記コマンドでPIDを確認してから）
wmic process where processid=XXXXX call terminate

# または全Pythonプロセスを終了
wmic process where "name like '%python%'" call terminate
```

**Claude Code経由での強制終了:**

Claude Codeでスクリプト実行中に止めたい場合：
```bash
# 1. PIDを確認
tasklist | findstr python

# 2. 表示されたPIDで強制終了（例: PID 227308）
powershell.exe -Command "Stop-Process -Id 227308 -Force"

# 3. 終了確認（結果が空なら成功）
tasklist | findstr python
```

### 中止ボタンが効かない場合

実行中に「中止」ボタンやEscキーが効かない場合：
1. 上記の方法でPythonプロセスを強制終了
2. サーバーを再起動: `python -m uvicorn main:app --reload --host 0.0.0.0 --port 8000`

## 設計判断メモ

### なぜテキストをID参照にしたか？

当初はテキストをインデックス（番号）で参照していた。しかし：

1. テキストを削除するとインデックスがずれる → フローが壊れる
2. テキストを編集したら、そのテキストを使う全フローに反映したい

→ **テキストに固定ID（8桁数字）を振り、フローはIDで参照する方式に変更**

### なぜAND検索を実装したか？

テキストが数百件になると、1つのキーワードでは絞り込めない。
例: 「報告」で検索 → 100件ヒット → 「報告 週次」で検索 → 5件に絞り込み

### なぜ待機中にカーソルを動かすか？

画像待機（最大30秒）中、ユーザーが「フリーズした？」と不安になる。
カーソルが小さく左右に動くことで「待機中だとわかっているよ」を視覚的に示す。

## Claude Code連携

### claude_query.py

Claude Codeから他のAI（Liner等）に自動でクエリを送るスクリプト。

```bash
python claude_query.py "質問内容" [フロー名]
# フロー名省略時は「通常プロンプト-Liner」がデフォルト
```

### 対話プロンプトのベストプラクティス

他のAIと対話する際、以下の一文を質問に追加することで、より充実した議論が可能になる：

```
議論をより有意義で充実したものにするために、あなたの方からも疑問点や追加テーマ、提案などがあれば、ぜひ共有してください。
```

**効果：**
- AIが受動的に答えるだけでなく、能動的に議論に参加するようになる
- 予想外の視点や関連トピックが提示される可能性が高まる
- 対話がより双方向的になる

### 外部実行検知（v0.71〜）

`claude_query.py`などから実行が開始されると、UIが自動検知して：
- ローディング画面と中止ボタンを表示
- Escキーまたは中止ボタンで停止可能

## 開発ルール

- **バージョン管理**: 修正するたびに version +0.01 でバージョン履歴に追記する

## バージョン履歴

- v0.51 - 休止ボタン復活、全コピーボタン修正、まとめてチェックで休止中除外
- v0.50 - バッチ実行順序表示（チェック順に番号バッジ表示、チェック順で実行）
- v0.47 - 検索タグ機能（検索頻度の高いキーワードを自動タグ化、上位10件表示）
- v0.46 - 秒待機のデフォルト10秒、増減幅1秒に変更
- v0.45 - バッチ実行の非同期API対応修正
- v0.44 - レイアウト調整（5狭く6広く）、実行中のリアルタイムステータス表示（5側に緑/赤）
- v0.43 - 画像クリックの自動リトライ機能（見つからない場合1秒待って再試行）
- v0.42 - アクションのドラッグ&ドロップ並び替え、画像サムネイルクリックで拡大プレビュー
- v0.41 - 開始前待機機能（ウィンドウ切替用）、中止機能のabortフラグ修正
- v0.40 - 自動認識精度フォールバック（95%→90%→...→最低精度）、リアルタイム進捗表示、中止ボタン強化
- v0.30 - バッチ実行（複数フローを順番に実行）、実行ログファイル出力、結果コピー機能
- v0.22 - click_or機能（複数画像のOR条件クリック）、画像認識失敗時の信頼度%表示
- v0.21 - 画像差し替え機能（🔄ボタン）、実行結果の色分け（成功:緑/失敗:赤）
- v0.20 - カーソル移動スムーズ化（easeInOutQuad）、エラーメッセージ詳細化
- v0.19 - アクション並び替え（上下）、テキスト差し替え機能
- v0.18 - リアルタイム検索、Ctrl+Enterでテキスト保存、Enterでフロー保存
- v0.17 - テキストID形式、AND検索、フロー保存機能
- v0.16 - フロー保存/読み込み機能
- v0.15 - 待機中カーソル移動、カーソル速度設定
- v0.14 - テキスト編集/削除ボタン（ホバー表示）
- v0.13 - アクション一覧にサムネイル表示
- v0.12 - テキスト貼り付け、画像待機機能
- v0.11 - 削除モードトグル
- v0.10 - Ctrl+V画像貼り付け対応
