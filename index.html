<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Image Click</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: white; text-align: center; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .version { position: fixed; top: 10px; right: 15px; color: rgba(255,255,255,0.7); font-size: 12px; }
        .panel { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .panel h2 { color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #667eea; font-size: 18px; }
        .settings { display: flex; gap: 20px; flex-wrap: wrap; align-items: center; }
        .setting-item { display: flex; align-items: center; gap: 10px; }
        .setting-item label { font-weight: bold; color: #555; font-size: 14px; }
        .setting-item input { width: 80px; padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; }
        .setting-item input:focus { outline: none; border-color: #667eea; }

        /* ãƒ¡ã‚¤ãƒ³ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ + ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-layout { display: grid; grid-template-columns: 180px 1fr; gap: 20px; }
        @media (max-width: 900px) { .main-layout { grid-template-columns: 1fr; } }

        /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®š */
        .sidebar-settings { padding: 15px; }
        .sidebar-settings h2 { font-size: 16px; margin-bottom: 10px; }
        .sidebar-settings .setting-item { flex-direction: column; align-items: flex-start; gap: 5px; margin-bottom: 12px; }
        .sidebar-settings .setting-item label { font-size: 12px; }
        .sidebar-settings .setting-item input { width: 100%; padding: 6px 8px; font-size: 13px; }
        .sidebar-settings .setting-item span { font-size: 11px; color: #888; }
        .sidebar-settings .setting-buttons { display: flex; flex-direction: column; gap: 5px; margin-top: 10px; }
        .sidebar-settings .setting-buttons button { width: 100%; padding: 6px 8px; font-size: 11px; }

        /* 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

        /* ç”»åƒãƒ»ãƒ†ã‚­ã‚¹ãƒˆä¸€è¦§ */
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto; }
        .item-card { border: 2px solid #ddd; border-radius: 8px; padding: 8px; cursor: pointer; transition: all 0.2s; background: #f9f9f9; position: relative; }
        .item-card:hover { border-color: #667eea; transform: translateY(-2px); }
        .item-card img { width: 100%; height: 60px; object-fit: contain; border-radius: 4px; background: white; }
        .item-card .name { text-align: center; margin-top: 5px; font-size: 10px; color: #555; word-break: break-all; }
        .item-card .delete-btn { position: absolute; top: 3px; left: 3px; background: #dc3545; color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 12px; display: none; align-items: center; justify-content: center; }
        .delete-mode .item-card .delete-btn { display: flex; }
        .item-card .replace-btn { position: absolute; top: 3px; right: 3px; background: #e7f3ff; color: #0066cc; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 10px; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .item-card:hover .replace-btn { opacity: 1; }
        .item-card .replace-btn:hover { background: #cce5ff; }
        .item-card .replace-btn.replacing { background: #ffc107; color: #333; opacity: 1; }
        .item-card.replacing { border-color: #ffc107; background: #fff3cd; animation: pulse 1s infinite; }

        /* ãƒ†ã‚­ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ */
        .text-card { border: 2px solid #17a2b8; background: #e7f7fa; padding: 10px; border-radius: 8px; cursor: pointer; position: relative; }
        .text-card:hover { border-color: #138496; }
        .text-card .text-index { font-weight: bold; color: #17a2b8; font-size: 12px; }
        .text-card .text-content { font-size: 11px; color: #333; margin-top: 3px; word-break: break-all; max-height: 40px; overflow: hidden; }
        .text-card .text-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .text-card .text-actions button { background: #6c757d; color: white; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; font-size: 11px; display: none; }
        .text-card:hover .text-actions button { display: block; }
        .text-card .text-actions .edit-btn:hover { background: #17a2b8; }
        .text-card .text-actions .delete-btn { background: #dc3545; }
        .text-card .text-actions .delete-btn:hover { background: #c82333; }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é †åº */
        .action-list { min-height: 100px; padding: 15px; background: #f5f5f5; border-radius: 8px; }
        .action-item { display: flex; align-items: center; gap: 10px; background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #667eea; }
        .action-item.click { border-left-color: #28a745; }
        .action-item.paste { border-left-color: #17a2b8; }
        .action-item.wait { border-left-color: #ffc107; }
        .action-item .action-num { font-weight: bold; color: #666; min-width: 25px; }
        .action-item .action-type { font-size: 11px; padding: 2px 8px; border-radius: 10px; color: white; }
        .action-item .action-type.click { background: #28a745; }
        .action-item .action-type.paste { background: #17a2b8; }
        .action-item .action-type.wait { background: #ffc107; color: #333; }
        .action-item .action-thumb { width: 40px; height: 30px; object-fit: contain; border-radius: 4px; background: #eee; cursor: pointer; transition: transform 0.2s; }
        .action-item .action-thumb:hover { transform: scale(1.1); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .action-item .action-desc { flex: 1; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: pointer; }
        .action-item .action-desc:hover { color: #667eea; text-decoration: underline; }
        .action-item .action-controls { display: flex; gap: 3px; }
        .action-item .action-controls button { background: #e9ecef; border: none; width: 22px; height: 22px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .action-item .action-controls button:hover { background: #dee2e6; }
        .action-item .action-controls .up-btn, .action-item .action-controls .down-btn { color: #666; }
        .action-item .action-controls .remove-btn { background: #f8d7da; color: #dc3545; }
        .action-item .action-controls .remove-btn:hover { background: #f5c6cb; }
        .action-item .action-controls .swap-btn { background: #e7f3ff; color: #0066cc; }
        .action-item .action-controls .swap-btn:hover { background: #cce5ff; }
        .action-item .action-controls .swap-btn.swapping { background: #ffc107; color: #333; }
        .action-item.swapping { background: #fff3cd; border-left-color: #ffc107; animation: pulse 1s infinite; }
        .action-item .action-controls .add-img-btn { background: #d4edda; color: #28a745; font-weight: bold; }
        .action-item .action-controls .add-img-btn:hover { background: #c3e6cb; }
        .action-item .action-controls .add-img-btn.adding { background: #28a745; color: white; }
        .action-item.adding { background: #d4edda; border-left-color: #28a745; animation: pulse 1s infinite; }
        .action-item.click_or { border-left-color: #6f42c1; }
        .action-item .action-type.click_or { background: #6f42c1; }
        .action-item.wait_disappear { border-left-color: #17a2b8; }
        .action-item .action-type.wait_disappear { background: #17a2b8; }
        .action-item.wait_seconds { border-left-color: #6c757d; }
        .action-item .action-type.wait_seconds { background: #6c757d; }
        .action-item.pagedown { border-left-color: #20c997; }
        .action-item .action-type.pagedown { background: #20c997; }
        .action-item.save_to_file { border-left-color: #e83e8c; }
        .action-item .action-type.save_to_file { background: #e83e8c; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .empty-message { color: #999; font-style: italic; text-align: center; padding: 20px; }

        /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
        .action-item { cursor: grab; }
        .action-item:active { cursor: grabbing; }
        .action-item.dragging { opacity: 0.5; background: #e9ecef; }
        .action-item.drag-over { border-top: 3px solid #667eea; margin-top: -3px; }
        .action-item .drag-handle { color: #999; margin-right: 5px; cursor: grab; }

        /* ãƒœã‚¿ãƒ³ */
        .button-group { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: #333; }

        /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ãƒœã‚¿ãƒ³ */
        .action-buttons { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
        .action-buttons .btn { font-size: 12px; padding: 8px 15px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; }
        .modal-content h3 { margin-bottom: 15px; color: #333; }
        .modal-content input, .modal-content textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; margin-bottom: 15px; }
        .modal-content textarea { height: 100px; resize: vertical; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }

        /* ãƒˆã‚°ãƒ« */
        .toggle-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .toggle-switch { position: relative; width: 44px; height: 24px; background: #ccc; border-radius: 12px; cursor: pointer; transition: background 0.3s; }
        .toggle-switch.active { background: #dc3545; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: left 0.3s; }
        .toggle-switch.active::after { left: 22px; }
        .toggle-label { font-size: 13px; color: #666; }
        .toggle-label.active { color: #dc3545; font-weight: bold; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ */
        .upload-area { border: 2px dashed #ccc; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; margin-bottom: 15px; }
        .upload-area:hover { border-color: #667eea; background: #f8f9ff; }
        .upload-area.dragover { border-color: #28a745; background: #e8f5e9; }
        .upload-icon { font-size: 30px; }
        .upload-text { color: #666; font-size: 12px; }
        .upload-area input[type="file"] { display: none; }

        /* çµæœ */
        .result { margin-top: 15px; padding: 15px; border-radius: 8px; display: none; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; display: block; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; display: block; }
        .result-details { margin-top: 10px; font-size: 13px; }
        .result-details li { margin: 5px 0; padding: 8px 10px; border-radius: 4px; list-style: none; }
        .result-details li.item-success { background: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .result-details li.item-error { background: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }

        .loading { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .info { background: #e7f3ff; border: 1px solid #b8daff; color: #004085; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-size: 12px; }

        /* ãƒ•ãƒ­ãƒ¼ä¸€è¦§ */
        .flow-list { max-height: 200px; overflow-y: auto; }
        .flow-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #6f42c1; }
        .flow-item:hover { background: #e9ecef; }
        .flow-item .flow-name { flex: 1; font-weight: bold; color: #333; cursor: pointer; }
        .flow-item .flow-name:hover { color: #6f42c1; }
        .flow-item .flow-meta { font-size: 11px; color: #666; }
        .flow-item .flow-actions { display: flex; gap: 5px; }
        .flow-item .flow-actions button { background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .flow-item .flow-actions .load-btn { background: #6f42c1; }
        .flow-item .flow-actions .load-btn:hover { background: #5a32a3; }
        .flow-item .flow-actions .rename-btn { background: #17a2b8; }
        .flow-item .flow-actions .rename-btn:hover { background: #138496; }
        .flow-item .flow-actions .delete-btn { background: #dc3545; }
        .flow-item .flow-actions .delete-btn:hover { background: #c82333; }
        .flow-item .flow-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .flow-item.selected { background: #e8daff; border-left-color: #6f42c1; }
        .btn-purple { background: #6f42c1; color: white; }
        .btn-purple:hover { background: #5a32a3; }
    </style>
</head>
<body>
    <div class="version">v0.43</div>
    <div class="container">
        <h1>Simple Image Click</h1>

        <div class="main-layout">
            <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼: è¨­å®š -->
            <div class="panel sidebar-settings">
                <h2>1. è¨­å®š</h2>
                <div class="setting-item">
                    <label>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é–“éš”</label>
                    <input type="number" id="interval" value="2" min="0.1" max="60" step="0.1">
                    <span>ç§’</span>
                </div>
                <div class="setting-item">
                    <label>èªè­˜ç²¾åº¦</label>
                    <input type="number" id="confidence" value="0.95" min="0.1" max="1.0" step="0.05">
                </div>
                <div class="setting-item">
                    <label>æœ€ä½ç²¾åº¦</label>
                    <input type="number" id="minConfidence" value="0.7" min="0.1" max="1.0" step="0.05">
                    <span title="ã“ã®å€¤ã¾ã§æ®µéšçš„ã«ä¸‹ã’ã¦è©¦ã™">?</span>
                </div>
                <div class="setting-item">
                    <label>å¾…æ©Ÿã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ</label>
                    <input type="number" id="waitTimeout" value="1800" min="1" max="7200" step="1">
                    <span>ç§’</span>
                </div>
                <div class="setting-item">
                    <label>ã‚«ãƒ¼ã‚½ãƒ«é€Ÿåº¦</label>
                    <input type="number" id="cursorSpeed" value="0.5" min="0.1" max="3.0" step="0.1">
                    <span>ç§’</span>
                </div>
                <div class="setting-item">
                    <label>é–‹å§‹å‰å¾…æ©Ÿ</label>
                    <input type="number" id="startDelay" value="0" min="0" max="30" step="1">
                    <span title="å®Ÿè¡Œé–‹å§‹å‰ã®å¾…æ©Ÿæ™‚é–“ï¼ˆã‚¦ã‚£ãƒ³ãƒ‰ã‚¦åˆ‡æ›¿ç”¨ï¼‰">ç§’</span>
                </div>
                <div class="setting-buttons">
                    <button class="btn btn-secondary" onclick="saveDefaultSettings()">ãƒ‡ãƒ•ã‚©ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="resetDefaultSettings()">ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div class="main-content">

        <div class="two-col">
            <!-- å·¦: ç”»åƒä¸€è¦§ -->
            <div class="panel">
                <h2>2. ç”»åƒä¸€è¦§</h2>
                <div class="toggle-row">
                    <div id="deleteToggle" class="toggle-switch" onclick="toggleDeleteMode()"></div>
                    <span id="deleteLabel" class="toggle-label">å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ OFF</span>
                    <span style="margin-left:auto;font-size:11px;color:#888;">Ctrl+Vã§è¿½åŠ </span>
                </div>
                <div id="imageGrid" class="item-grid"></div>
            </div>

            <!-- å³: ãƒ†ã‚­ã‚¹ãƒˆä¸€è¦§ï¼ˆåºƒã‚ï¼‰ -->
            <div class="panel">
                <h2>3. ãƒ†ã‚­ã‚¹ãƒˆä¸€è¦§</h2>
                <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;align-items:center;">
                    <button class="btn btn-info" onclick="showAddTextModal()">+ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
                    <input type="text" id="textSearch" placeholder="æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ANDãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰" style="flex:1;min-width:150px;padding:8px;border:2px solid #ddd;border-radius:6px;" oninput="searchTexts()">
                    <button class="btn btn-secondary" onclick="clearTextSearch()" style="padding:8px 12px;">ã‚¯ãƒªã‚¢</button>
                </div>
                <div id="textGrid" class="item-grid" style="grid-template-columns: 1fr;"></div>
            </div>
        </div>

        <!-- ãƒ•ãƒ­ãƒ¼ä¸€è¦§ -->
        <div class="panel">
            <h2>4. ä¿å­˜æ¸ˆã¿ãƒ•ãƒ­ãƒ¼</h2>
            <div style="display:flex;gap:10px;margin-bottom:10px;align-items:center;flex-wrap:wrap;">
                <span id="selectedFlowCount" style="font-size:12px;color:#666;">0ä»¶é¸æŠä¸­</span>
                <span id="batchHint" style="font-size:11px;color:#6f42c1;display:none;">â†’ ãƒ†ã‚­ã‚¹ãƒˆä¸€è¦§ã‹ã‚‰é¸æŠã—ã¦å®Ÿè¡Œ</span>
            </div>
            <div id="flowList" class="flow-list" style="max-height:300px;">
                <p class="empty-message">ãƒ•ãƒ­ãƒ¼ã‚’ä¿å­˜ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
        </div>

        <div class="two-col" style="grid-template-columns: 1fr 1fr;">
            <!-- å·¦: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é †åº -->
            <div class="panel">
                <h2>5. ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é †åº</h2>
                <div class="action-buttons">
                    <span style="color:#666;font-size:12px;">ãƒ¢ãƒ¼ãƒ‰:</span>
                    <button class="btn btn-success" id="modeClick" onclick="setAddMode('click')" style="padding:5px 10px;font-size:11px;">ã‚¯ãƒªãƒƒã‚¯</button>
                    <button class="btn btn-warning" id="modeWait" onclick="setAddMode('wait')" style="padding:5px 10px;font-size:11px;">è¡¨ç¤ºå¾…æ©Ÿ</button>
                    <button class="btn btn-info" id="modeWaitDisappear" onclick="setAddMode('wait_disappear')" style="padding:5px 10px;font-size:11px;">æ¶ˆå¤±å¾…æ©Ÿ</button>
                    <span style="color:#666;font-size:12px;margin-left:10px;">|</span>
                    <input type="number" id="waitSecondsInput" value="5" min="0.1" max="300" step="0.1" style="width:50px;padding:4px;font-size:11px;border:1px solid #ccc;border-radius:4px;">
                    <button class="btn btn-secondary" onclick="addWaitSecondsAction()" style="padding:5px 10px;font-size:11px;">ç§’å¾…æ©Ÿ</button>
                    <span style="color:#666;font-size:12px;margin-left:10px;">|</span>
                    <input type="number" id="pagedownCountInput" value="10" min="1" max="100" step="1" style="width:40px;padding:4px;font-size:11px;border:1px solid #ccc;border-radius:4px;">
                    <button class="btn btn-secondary" onclick="addPagedownAction()" style="padding:5px 10px;font-size:11px;">PgDn</button>
                    <span style="color:#666;font-size:12px;margin-left:10px;">|</span>
                    <button class="btn" onclick="addSaveToFileAction()" style="padding:5px 10px;font-size:11px;background:#e83e8c;color:white;">ğŸ“„ä¿å­˜</button>
                </div>
                <div id="actionList" class="action-list" style="max-height:400px;overflow-y:auto;">
                    <p class="empty-message">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ...</p>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" id="executeBtn" disabled onclick="executeActions()">â–¶ å®Ÿè¡Œ</button>
                    <button class="btn btn-info" id="templateExecBtn" disabled onclick="showTemplateExecModal()">â–¶ ãƒ†ãƒ³ãƒ—ãƒ¬å®Ÿè¡Œ</button>
                    <button class="btn btn-purple" id="saveFlowBtn" disabled onclick="showSaveFlowModal()">ğŸ’¾ ä¿å­˜</button>
                    <button class="btn btn-secondary" id="copyAllBtn" disabled onclick="copyActionsAndResult()">ğŸ“‹ å…¨ã‚³ãƒ”ãƒ¼</button>
                    <button class="btn btn-secondary" onclick="clearActions()">ã‚¯ãƒªã‚¢</button>
                </div>
            </div>

            <!-- å³: çµæœè¡¨ç¤ºï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆï¼‰ -->
            <div class="panel">
                <h2>6. å®Ÿè¡Œçµæœ</h2>
                <div class="info">
                    ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ ã‚¯ãƒªãƒƒã‚¯/å¾…æ©Ÿè¿½åŠ  | ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ â†’ è²¼ã‚Šä»˜ã‘è¿½åŠ 
                </div>
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-bottom:15px;">å®Ÿè¡Œä¸­...</p>
                    <button id="abortBtn" onclick="abortExecution()" style="padding:20px 60px;font-size:24px;font-weight:bold;background:#dc3545;color:white;border:none;border-radius:12px;cursor:pointer;box-shadow:0 4px 15px rgba(220,53,69,0.4);">ğŸ›‘ ä¸­æ­¢ (Esc)</button>
                    <p style="margin-top:10px;font-size:14px;color:#666;">Escã‚­ãƒ¼ã§ã‚‚ä¸­æ­¢ã§ãã¾ã™</p>
                    <div id="progressList" style="text-align:left;margin-top:10px;font-size:12px;max-height:200px;overflow-y:auto;"></div>
                </div>
                <div class="result" id="result">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong id="resultMessage"></strong>
                        <button onclick="copyResult()" style="padding:4px 8px;font-size:12px;cursor:pointer;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
                    </div>
                    <ul class="result-details" id="resultDetails"></ul>
                </div>
                <div id="resultPlaceholder" style="color:#999;text-align:center;padding:40px;">å®Ÿè¡ŒçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
        </div>

            </div><!-- /main-content -->
        </div><!-- /main-layout -->
    </div>

    <!-- ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="textModal">
        <div class="modal-content">
            <h3 id="textModalTitle">ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </h3>
            <textarea id="textInput" placeholder="è²¼ã‚Šä»˜ã‘ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›...ï¼ˆCtrl+Enterã§ä¿å­˜ï¼‰" onkeydown="if(event.ctrlKey && event.key === 'Enter') saveText()"></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideTextModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-primary" onclick="saveText()">ä¿å­˜ (Ctrl+Enter)</button>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="flowModal">
        <div class="modal-content">
            <h3>ãƒ•ãƒ­ãƒ¼ã‚’ä¿å­˜</h3>
            <input type="text" id="flowNameInput" placeholder="ãƒ•ãƒ­ãƒ¼åã‚’å…¥åŠ›ï¼ˆä¾‹: é€±æ¬¡å ±å‘Šæ›¸ä½œæˆï¼‰" onkeydown="if(event.key === 'Enter') saveFlow()">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideFlowModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-purple" onclick="saveFlow()">ä¿å­˜ (Enter)</button>
            </div>
        </div>
    </div>

    <!-- ãƒ•ãƒ­ãƒ¼åå‰å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="renameFlowModal">
        <div class="modal-content">
            <h3>ãƒ•ãƒ­ãƒ¼åã‚’å¤‰æ›´</h3>
            <input type="text" id="renameFlowInput" placeholder="æ–°ã—ã„ãƒ•ãƒ­ãƒ¼å" onkeydown="if(event.key === 'Enter') confirmRenameFlow()">
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="hideRenameFlowModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn btn-info" onclick="confirmRenameFlow()">å¤‰æ›´ (Enter)</button>
            </div>
        </div>
    </div>

    <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="imagePreviewModal" onclick="hideImagePreviewModal()">
        <div class="modal-content" style="max-width:800px;text-align:center;" onclick="event.stopPropagation()">
            <h3 id="imagePreviewTitle" style="margin-bottom:15px;"></h3>
            <img id="imagePreviewImg" src="" style="max-width:100%;max-height:70vh;border:2px solid #ddd;border-radius:8px;">
            <div class="modal-buttons" style="margin-top:15px;">
                <button class="btn btn-secondary" onclick="hideImagePreviewModal()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®Ÿè¡Œãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal" id="templateExecModal">
        <div class="modal-content" style="max-width:600px;">
            <h3>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®Ÿè¡Œ - ãƒ†ã‚­ã‚¹ãƒˆé¸æŠ</h3>
            <p style="font-size:13px;color:#666;margin-bottom:10px;">è²¼ä»˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
            <input type="text" id="templateTextSearch" placeholder="æ¤œç´¢ï¼ˆã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§ANDï¼‰" oninput="filterTemplateTexts()" style="margin-bottom:10px;">
            <div id="templateTextList" style="max-height:300px;overflow-y:auto;"></div>
            <div class="modal-buttons" style="margin-top:15px;">
                <button class="btn btn-secondary" onclick="hideTemplateExecModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>


    <script>
        // çŠ¶æ…‹
        let images = [];
        let texts = {};  // IDä»˜ãè¾æ›¸å½¢å¼ {id: {id, text, created_at}}
        let filteredTextIds = null;  // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœï¼ˆnullã¯å…¨ä»¶è¡¨ç¤ºï¼‰
        let actions = [];
        let flows = {};
        let deleteMode = false;
        let addMode = 'click'; // 'click' or 'wait'
        let editingTextId = null;
        let currentFlowName = null;  // èª­ã¿è¾¼ã‚“ã ãƒ•ãƒ­ãƒ¼åã‚’è¨˜æ†¶

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šå€¤
        const DEFAULT_SETTINGS = {
            interval: 2,
            confidence: 0.95,
            waitTimeout: 1800,
            cursorSpeed: 0.5,
            startDelay: 0
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            loadSavedSettings();  // ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿
            await loadImages();
            await loadTexts();
            await loadFlows();
            setupEventListeners();
            setAddMode('click');
        });

        // è¨­å®šã®ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ï¼ˆlocalStorageï¼‰
        function loadSavedSettings() {
            const saved = localStorage.getItem('simpleImageClickSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    document.getElementById('interval').value = settings.interval ?? DEFAULT_SETTINGS.interval;
                    document.getElementById('confidence').value = settings.confidence ?? DEFAULT_SETTINGS.confidence;
                    document.getElementById('waitTimeout').value = settings.waitTimeout ?? DEFAULT_SETTINGS.waitTimeout;
                    document.getElementById('cursorSpeed').value = settings.cursorSpeed ?? DEFAULT_SETTINGS.cursorSpeed;
                    document.getElementById('startDelay').value = settings.startDelay ?? DEFAULT_SETTINGS.startDelay;
                } catch (e) {
                    console.error('è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
                }
            }
        }

        function saveDefaultSettings() {
            const settings = {
                interval: parseFloat(document.getElementById('interval').value),
                confidence: parseFloat(document.getElementById('confidence').value),
                waitTimeout: parseFloat(document.getElementById('waitTimeout').value),
                cursorSpeed: parseFloat(document.getElementById('cursorSpeed').value),
                startDelay: parseFloat(document.getElementById('startDelay').value)
            };
            localStorage.setItem('simpleImageClickSettings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ');
        }

        function resetDefaultSettings() {
            localStorage.removeItem('simpleImageClickSettings');
            document.getElementById('interval').value = DEFAULT_SETTINGS.interval;
            document.getElementById('confidence').value = DEFAULT_SETTINGS.confidence;
            document.getElementById('waitTimeout').value = DEFAULT_SETTINGS.waitTimeout;
            document.getElementById('cursorSpeed').value = DEFAULT_SETTINGS.cursorSpeed;
            document.getElementById('startDelay').value = DEFAULT_SETTINGS.startDelay;
            alert('è¨­å®šã‚’åˆæœŸå€¤ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }

        // ç”»åƒèª­ã¿è¾¼ã¿
        async function loadImages() {
            const res = await fetch('/api/images');
            const data = await res.json();
            images = data.images;
            renderImages();
        }

        // ãƒ†ã‚­ã‚¹ãƒˆèª­ã¿è¾¼ã¿
        async function loadTexts() {
            const res = await fetch('/api/texts');
            const data = await res.json();
            texts = data.texts;
            renderTexts();
        }

        // ç”»åƒæç”»
        function renderImages() {
            const grid = document.getElementById('imageGrid');
            if (images.length === 0) {
                grid.innerHTML = '<p class="empty-message">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>';
                return;
            }
            grid.innerHTML = images.map(img => {
                const isReplacing = replacingImageName === img.name;
                return `
                <div class="item-card ${isReplacing ? 'replacing' : ''}" onclick="addImageAction('${img.name}')">
                    <button class="delete-btn" onclick="event.stopPropagation(); deleteImage('${img.name}')">âœ•</button>
                    ${isReplacing
                        ? `<button class="replace-btn replacing" onclick="event.stopPropagation(); cancelReplaceImage()" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">âœ•</button>`
                        : `<button class="replace-btn" onclick="event.stopPropagation(); startReplaceImage('${img.name}')" title="ç”»åƒå·®ã—æ›¿ãˆ">ğŸ”„</button>`
                    }
                    <img src="${img.path}?t=${Date.now()}" alt="${img.name}">
                    <div class="name">${img.name}</div>
                </div>
            `}).join('');
        }

        // ãƒ†ã‚­ã‚¹ãƒˆæç”»
        function renderTexts() {
            const grid = document.getElementById('textGrid');
            const textIds = filteredTextIds || Object.keys(texts);
            if (textIds.length === 0) {
                grid.innerHTML = '<p class="empty-message">ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>';
                return;
            }
            grid.innerHTML = textIds.map(id => {
                const t = texts[id];
                if (!t) return '';
                return `
                <div class="text-card" onclick="addPasteAction('${id}')">
                    <div class="text-actions">
                        <button class="edit-btn" onclick="event.stopPropagation(); editText('${id}')" title="ç·¨é›†">âœ</button>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteText('${id}')" title="å‰Šé™¤">âœ•</button>
                    </div>
                    <div class="text-index">[${id}]</div>
                    <div class="text-content">${escapeHtml(t.text)}</div>
                </div>
            `}).join('');
        }

        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ï¼ˆANDæ¤œç´¢ï¼‰
        function searchTexts() {
            const query = document.getElementById('textSearch').value.trim();
            if (!query) {
                filteredTextIds = null;
                renderTexts();
                return;
            }
            const keywords = query.toLowerCase().split(/\s+/).filter(k => k);
            filteredTextIds = Object.keys(texts).filter(id => {
                const text = texts[id].text.toLowerCase();
                return keywords.every(kw => text.includes(kw));
            });
            renderTexts();
        }

        function clearTextSearch() {
            document.getElementById('textSearch').value = '';
            filteredTextIds = null;
            renderTexts();
        }

        // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
        function escapeHtml(str) {
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
        }

        // çµæœã‚’ã‚³ãƒ”ãƒ¼
        function copyResult() {
            const msg = document.getElementById('resultMessage').textContent;
            const details = document.getElementById('resultDetails').innerText;
            const text = msg + '\n' + details;
            navigator.clipboard.writeText(text);
            showCopyFeedback(event.target);
        }

        // ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
        function showCopyFeedback(btn) {
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
            btn.style.background = '#28a745';
            btn.style.color = 'white';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
                btn.style.color = '';
            }, 1500);
        }

        // è¿½åŠ ãƒ¢ãƒ¼ãƒ‰è¨­å®š
        function setAddMode(mode) {
            addMode = mode;
            document.getElementById('modeClick').style.opacity = mode === 'click' ? 1 : 0.5;
            document.getElementById('modeWait').style.opacity = mode === 'wait' ? 1 : 0.5;
            document.getElementById('modeWaitDisappear').style.opacity = mode === 'wait_disappear' ? 1 : 0.5;
        }

        // ç”»åƒã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
        function addImageAction(imageName) {
            if (deleteMode) return;
            // ORç”»åƒè¿½åŠ ãƒ¢ãƒ¼ãƒ‰ä¸­
            if (addingImageToActionIndex !== null) {
                addImageToAction(imageName);
                return;
            }
            actions.push({ type: addMode, image_name: imageName });
            renderActions();
        }

        // ç§’æ•°å¾…æ©Ÿã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
        function addWaitSecondsAction() {
            const seconds = parseFloat(document.getElementById('waitSecondsInput').value) || 5;
            if (seconds <= 0) {
                alert('ç§’æ•°ã¯0ã‚ˆã‚Šå¤§ãã„å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            actions.push({ type: 'wait_seconds', seconds: seconds });
            renderActions();
        }

        // PageDownã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
        function addPagedownAction() {
            const count = parseInt(document.getElementById('pagedownCountInput').value) || 1;
            if (count < 1) {
                alert('å›æ•°ã¯1ä»¥ä¸Šã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            actions.push({ type: 'pagedown', count: count });
            renderActions();
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 
        function addSaveToFileAction() {
            // ç¾åœ¨ã®ãƒ•ãƒ­ãƒ¼ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ†ã‚­ã‚¹ãƒˆIDã‚’æ¢ã™ï¼ˆè²¼ä»˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ï¼‰
            const pasteAction = actions.find(a => a.type === 'paste');
            const textId = pasteAction ? pasteAction.text_id : null;
            actions.push({ type: 'save_to_file', text_id: textId, flow_name: currentFlowName });
            renderActions();
        }

        // è²¼ã‚Šä»˜ã‘ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆIDãƒ™ãƒ¼ã‚¹ï¼‰/ å·®ã—æ›¿ãˆ / ãƒãƒƒãƒå®Ÿè¡Œ
        function addPasteAction(textId) {
            if (deleteMode) return;

            // å·®ã—æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ä¸­
            if (swappingActionIndex !== null) {
                actions[swappingActionIndex].text_id = textId;
                swappingActionIndex = null;
                renderActions();
                return;
            }

            // ãƒãƒƒãƒå®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ­ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
            if (selectedFlows.size > 0) {
                const flowNames = Array.from(selectedFlows);
                const textPreview = texts[textId] ? texts[textId].text.substring(0, 50) + '...' : textId;
                if (confirm(`é¸æŠã—ãŸ ${flowNames.length} ä»¶ã®ãƒ•ãƒ­ãƒ¼ã‚’é †ç•ªã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nãƒ•ãƒ­ãƒ¼: ${flowNames.join(', ')}\nãƒ†ã‚­ã‚¹ãƒˆ: ${textPreview}`)) {
                    executeBatchFlows(textId).catch(e => {
                        alert('ãƒãƒƒãƒå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:\n' + e.name + ': ' + e.message + '\n\nã‚¹ã‚¿ãƒƒã‚¯:\n' + e.stack);
                        console.error('ãƒãƒƒãƒå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', e);
                        document.getElementById('loading').classList.remove('show');
                    });
                }
                return;
            }

            actions.push({ type: 'paste', text_id: textId });
            renderActions();
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æç”»
        function renderActions() {
            const list = document.getElementById('actionList');
            const hasPasteAction = actions.some(a => a.type === 'paste');
            if (actions.length === 0) {
                list.innerHTML = '<p class="empty-message">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ...</p>';
                document.getElementById('executeBtn').disabled = true;
                document.getElementById('templateExecBtn').disabled = true;
                document.getElementById('saveFlowBtn').disabled = true;
                document.getElementById('copyAllBtn').disabled = true;
                return;
            }
            document.getElementById('executeBtn').disabled = false;
            document.getElementById('templateExecBtn').disabled = !hasPasteAction;  // è²¼ä»˜ãŒã‚ã‚‹ã¨ãã ã‘æœ‰åŠ¹
            document.getElementById('saveFlowBtn').disabled = false;
            document.getElementById('copyAllBtn').disabled = false;
            list.innerHTML = actions.map((a, i) => {
                let desc = '';
                let typeLabel = '';
                let thumbHtml = '';
                if (a.type === 'click') {
                    typeLabel = 'ã‚¯ãƒªãƒƒã‚¯';
                    desc = a.image_name;
                    const img = images.find(x => x.name === a.image_name);
                    if (img) thumbHtml = `<img class="action-thumb" src="${img.path}" alt="" title="ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§" onclick="event.stopPropagation(); showImagePreview('${a.image_name}')">`;
                } else if (a.type === 'click_or') {
                    typeLabel = 'ã‚¯ãƒªãƒƒã‚¯OR';
                    desc = (a.image_names || []).join(' / ');
                    thumbHtml = (a.image_names || []).map(name => {
                        const img = images.find(x => x.name === name);
                        return img ? `<img class="action-thumb" src="${img.path}" alt="" title="${name} (ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§)" onclick="event.stopPropagation(); showImagePreview('${name}')">` : '';
                    }).join('');
                } else if (a.type === 'wait') {
                    typeLabel = 'è¡¨ç¤ºå¾…æ©Ÿ';
                    desc = a.image_name;
                    const img = images.find(x => x.name === a.image_name);
                    if (img) thumbHtml = `<img class="action-thumb" src="${img.path}" alt="" title="ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§" onclick="event.stopPropagation(); showImagePreview('${a.image_name}')">`;
                } else if (a.type === 'paste') {
                    typeLabel = 'è²¼ä»˜';
                    const textObj = texts[a.text_id];
                    desc = textObj ? `[${a.text_id}] ${textObj.text.substring(0, 20)}` : `[${a.text_id}] (å‰Šé™¤æ¸ˆã¿)`;
                } else if (a.type === 'wait_disappear') {
                    typeLabel = 'æ¶ˆå¤±å¾…æ©Ÿ';
                    desc = a.image_name;
                    const img = images.find(x => x.name === a.image_name);
                    if (img) thumbHtml = `<img class="action-thumb" src="${img.path}" alt="" title="ã‚¯ãƒªãƒƒã‚¯ã§æ‹¡å¤§" onclick="event.stopPropagation(); showImagePreview('${a.image_name}')">`;
                } else if (a.type === 'wait_seconds') {
                    typeLabel = 'ç§’å¾…æ©Ÿ';
                    desc = `${a.seconds}ç§’`;
                } else if (a.type === 'pagedown') {
                    typeLabel = 'PgDn';
                    desc = `${a.count || 1}å›`;
                } else if (a.type === 'save_to_file') {
                    typeLabel = 'ğŸ“„ä¿å­˜';
                    const textObj = a.text_id ? texts[a.text_id] : null;
                    const textPreview = textObj ? textObj.text.substring(0, 20) + '...' : '(ãƒ†ã‚­ã‚¹ãƒˆæœªæŒ‡å®š)';
                    desc = `${a.flow_name || '(ãƒ•ãƒ­ãƒ¼åãªã—)'} â†’ ${textPreview}`;
                }
                const canSwapText = a.type === 'paste';
                const canSwapImage = a.type === 'click' || a.type === 'wait' || a.type === 'wait_disappear';
                const canAddImage = a.type === 'click' || a.type === 'click_or';
                const isSwappingThis = swappingImageIndex === i;
                const isAddingToThis = addingImageToActionIndex === i;
                return `
                    <div class="action-item ${a.type} ${isSwappingThis ? 'swapping' : ''} ${isAddingToThis ? 'adding' : ''}" draggable="true" data-index="${i}" ondragstart="handleDragStart(event, ${i})" ondragover="handleDragOver(event, ${i})" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, ${i})" ondragend="handleDragEnd(event)">
                        <span class="drag-handle">â˜°</span>
                        <span class="action-num">${i + 1}.</span>
                        <span class="action-type ${a.type}">${typeLabel}</span>
                        ${thumbHtml}
                        <span class="action-desc" title="${escapeHtml(desc)}${canSwapText ? ' (ã‚¯ãƒªãƒƒã‚¯ã§å·®ã—æ›¿ãˆ)' : ''}" onclick="${canSwapText ? `startSwapText(${i})` : ''}">${escapeHtml(desc)}</span>
                        <div class="action-controls">
                            ${canAddImage ? (isAddingToThis
                                ? `<button class="add-img-btn adding" onclick="event.stopPropagation(); cancelAddImageToAction()" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">âœ•</button>`
                                : `<button class="add-img-btn" onclick="event.stopPropagation(); startAddImageToAction(${i})" title="ORç”»åƒã‚’è¿½åŠ ">+</button>`)
                            : ''}
                            ${canSwapImage ? (isSwappingThis
                                ? `<button class="swap-btn swapping" onclick="event.stopPropagation(); cancelSwapImage()" title="ã‚­ãƒ£ãƒ³ã‚»ãƒ«">âœ•</button>`
                                : `<button class="swap-btn" onclick="event.stopPropagation(); startSwapImage(${i})" title="ç”»åƒå·®ã—æ›¿ãˆ">ğŸ”„</button>`)
                            : ''}
                            <button class="remove-btn" onclick="event.stopPropagation(); removeAction(${i})" title="å‰Šé™¤">âœ•</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç§»å‹•ï¼ˆä¸Šä¸‹ï¼‰
        function moveAction(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= actions.length) return;
            const temp = actions[index];
            actions[index] = actions[newIndex];
            actions[newIndex] = temp;
            renderActions();
        }

        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—
        let draggedIndex = null;

        function handleDragStart(event, index) {
            draggedIndex = index;
            event.target.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', index);
        }

        function handleDragOver(event, index) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            if (draggedIndex !== null && draggedIndex !== index) {
                event.target.closest('.action-item')?.classList.add('drag-over');
            }
        }

        function handleDragLeave(event) {
            event.target.closest('.action-item')?.classList.remove('drag-over');
        }

        function handleDrop(event, targetIndex) {
            event.preventDefault();
            event.target.closest('.action-item')?.classList.remove('drag-over');

            if (draggedIndex === null || draggedIndex === targetIndex) return;

            // é…åˆ—ã‹ã‚‰ãƒ‰ãƒ©ãƒƒã‚°å…ƒã‚’å–ã‚Šå‡ºã—ã¦ã‚¿ãƒ¼ã‚²ãƒƒãƒˆä½ç½®ã«æŒ¿å…¥
            const [draggedItem] = actions.splice(draggedIndex, 1);
            actions.splice(targetIndex, 0, draggedItem);

            draggedIndex = null;
            renderActions();
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            // ã™ã¹ã¦ã®drag-overã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
            document.querySelectorAll('.action-item.drag-over').forEach(el => el.classList.remove('drag-over'));
            draggedIndex = null;
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å‰Šé™¤
        function removeAction(index) {
            actions.splice(index, 1);
            renderActions();
        }

        // ãƒ†ã‚­ã‚¹ãƒˆå·®ã—æ›¿ãˆé–‹å§‹
        let swappingActionIndex = null;
        function startSwapText(index) {
            swappingActionIndex = index;
            alert('ãƒ†ã‚­ã‚¹ãƒˆä¸€è¦§ã‹ã‚‰å·®ã—æ›¿ãˆå…ˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
        }

        // ç”»åƒå·®ã—æ›¿ãˆé–‹å§‹
        let swappingImageIndex = null;
        function startSwapImage(index) {
            swappingImageIndex = index;
            renderActions();  // ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
            alert('Ctrl+V ã§æ–°ã—ã„ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        }

        // ç”»åƒå·®ã—æ›¿ãˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç”¨ï¼‰
        function cancelSwapImage() {
            swappingImageIndex = null;
            renderActions();
        }

        // ç”»åƒä¸€è¦§ã®å·®ã—æ›¿ãˆ
        let replacingImageName = null;
        function startReplaceImage(imageName) {
            replacingImageName = imageName;
            renderImages();
            alert('Ctrl+V ã§æ–°ã—ã„ç”»åƒã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„');
        }

        function cancelReplaceImage() {
            replacingImageName = null;
            renderImages();
        }

        // ORç”»åƒè¿½åŠ ãƒ¢ãƒ¼ãƒ‰
        let addingImageToActionIndex = null;
        function startAddImageToAction(index) {
            addingImageToActionIndex = index;
            renderActions();
            alert('ç”»åƒä¸€è¦§ã‹ã‚‰è¿½åŠ ã™ã‚‹ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
        }

        function cancelAddImageToAction() {
            addingImageToActionIndex = null;
            renderActions();
        }

        function addImageToAction(imageName) {
            if (addingImageToActionIndex === null) return;
            const action = actions[addingImageToActionIndex];
            if (action.type === 'click') {
                // click â†’ click_or ã«å¤‰æ›
                actions[addingImageToActionIndex] = {
                    type: 'click_or',
                    image_names: [action.image_name, imageName]
                };
            } else if (action.type === 'click_or') {
                // æ—¢å­˜ã®click_orã«è¿½åŠ 
                action.image_names.push(imageName);
            }
            addingImageToActionIndex = null;
            renderActions();
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢
        function clearActions() {
            actions = [];
            currentFlowName = null;  // ãƒ•ãƒ­ãƒ¼åã‚‚ãƒªã‚»ãƒƒãƒˆ
            renderActions();
            document.getElementById('result').className = 'result';
        }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä¸€è¦§ï¼‹å®Ÿè¡Œçµæœã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyActionsAndResult() {
            if (actions.length === 0) return;
            const lines = actions.map((a, i) => {
                if (a.type === 'click') {
                    return `${i + 1}. ã‚¯ãƒªãƒƒã‚¯, ${a.image_name}`;
                } else if (a.type === 'click_or') {
                    return `${i + 1}. ã‚¯ãƒªãƒƒã‚¯OR, ${(a.image_names || []).join(' / ')}`;
                } else if (a.type === 'wait') {
                    return `${i + 1}. è¡¨ç¤ºå¾…æ©Ÿ, ${a.image_name}`;
                } else if (a.type === 'wait_disappear') {
                    return `${i + 1}. æ¶ˆå¤±å¾…æ©Ÿ, ${a.image_name}`;
                } else if (a.type === 'wait_seconds') {
                    return `${i + 1}. ç§’å¾…æ©Ÿ, ${a.seconds}ç§’`;
                } else if (a.type === 'pagedown') {
                    return `${i + 1}. PgDn, ${a.count || 1}å›`;
                } else if (a.type === 'save_to_file') {
                    return `${i + 1}. ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜, ${a.flow_name || '(åå‰ãªã—)'}`;
                } else if (a.type === 'paste') {
                    const textObj = texts[a.text_id];
                    const textPreview = textObj ? textObj.text.substring(0, 50) : '(å‰Šé™¤æ¸ˆã¿)';
                    return `${i + 1}. è²¼ä»˜, [ID:${a.text_id}] ${textPreview}`;
                }
                return `${i + 1}. ${a.type}`;
            });
            const flowHeader = currentFlowName ? `ãƒ•ãƒ­ãƒ¼: ${currentFlowName}\n` : '';
            const actionText = flowHeader + lines.join('\n');

            // å®Ÿè¡Œçµæœã‚‚å–å¾—
            const resultMsg = document.getElementById('resultMessage').textContent || '';
            const resultDetails = document.getElementById('resultDetails').innerText || '';
            const resultText = resultMsg ? `\n\n${resultMsg}\n${resultDetails}` : '';

            const fullText = actionText + resultText;
            navigator.clipboard.writeText(fullText);
            showCopyFeedback(event.target);
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå®Ÿè¡Œãƒ¢ãƒ¼ãƒ€ãƒ«
        let templateFilteredTextIds = null;

        function showTemplateExecModal() {
            // è²¼ä»˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹ã‹ç¢ºèª
            const hasPaste = actions.some(a => a.type === 'paste');
            if (!hasPaste) {
                alert('è²¼ä»˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            templateFilteredTextIds = null;
            document.getElementById('templateTextSearch').value = '';
            renderTemplateTextList();
            document.getElementById('templateExecModal').classList.add('show');
            // æ¤œç´¢æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            setTimeout(() => document.getElementById('templateTextSearch').focus(), 100);
        }

        function hideTemplateExecModal() {
            document.getElementById('templateExecModal').classList.remove('show');
        }

        function filterTemplateTexts() {
            const query = document.getElementById('templateTextSearch').value.trim();
            if (!query) {
                templateFilteredTextIds = null;
            } else {
                const keywords = query.toLowerCase().split(/\s+/).filter(k => k);
                templateFilteredTextIds = Object.keys(texts).filter(id => {
                    const text = texts[id].text.toLowerCase();
                    return keywords.every(kw => text.includes(kw));
                });
            }
            renderTemplateTextList();
        }

        function renderTemplateTextList() {
            const list = document.getElementById('templateTextList');
            const textIds = templateFilteredTextIds || Object.keys(texts);
            if (textIds.length === 0) {
                list.innerHTML = '<p class="empty-message">ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            list.innerHTML = textIds.map(id => {
                const t = texts[id];
                if (!t) return '';
                return `
                    <div class="text-card" onclick="executeWithTemplate('${id}')" style="cursor:pointer;margin-bottom:8px;">
                        <div class="text-index">[${id}]</div>
                        <div class="text-content" style="max-height:60px;">${escapeHtml(t.text)}</div>
                    </div>
                `;
            }).join('');
        }

        async function executeWithTemplate(textId) {
            hideTemplateExecModal();

            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦è²¼ä»˜ã¨ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã®text_idã‚’å·®ã—æ›¿ãˆ
            const templateActions = actions.map(a => {
                if (a.type === 'paste') {
                    return { ...a, text_id: textId };
                }
                if (a.type === 'save_to_file') {
                    return { ...a, text_id: textId };
                }
                return { ...a };
            });

            // å®Ÿè¡Œ
            const interval = parseFloat(document.getElementById('interval').value) || 2;
            const confidence = parseFloat(document.getElementById('confidence').value) || 0.95;
            const minConfidence = parseFloat(document.getElementById('minConfidence').value) || 0.7;
            const waitTimeout = parseFloat(document.getElementById('waitTimeout').value) || 1800;
            const cursorSpeed = parseFloat(document.getElementById('cursorSpeed').value) || 0.5;
            const startDelay = parseFloat(document.getElementById('startDelay').value) || 0;

            document.getElementById('loading').classList.add('show');
            document.getElementById('result').className = 'result';
            document.getElementById('progressList').innerHTML = '';

            try {
                const res = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ actions: templateActions, interval, confidence, min_confidence: minConfidence, wait_timeout: waitTimeout, cursor_speed: cursorSpeed, start_delay: startDelay })
                });
                const startResult = await res.json();

                if (startResult.status === 'started') {
                    startProgressPolling();
                } else if (res.status === 409) {
                    document.getElementById('loading').classList.remove('show');
                    alert(startResult.detail || 'æ—¢ã«å®Ÿè¡Œä¸­ã§ã™');
                } else {
                    document.getElementById('loading').classList.remove('show');
                    showResult(startResult);
                }
            } catch (e) {
                document.getElementById('loading').classList.remove('show');
                showResult({ success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message, details: [] });
            }
        }

        // å®Ÿè¡ŒçŠ¶æ…‹ãƒãƒ¼ãƒªãƒ³ã‚°ç”¨
        let pollingInterval = null;

        // å®Ÿè¡Œ
        async function executeActions() {
            const interval = parseFloat(document.getElementById('interval').value) || 2;
            const confidence = parseFloat(document.getElementById('confidence').value) || 0.95;
            const minConfidence = parseFloat(document.getElementById('minConfidence').value) || 0.7;
            const waitTimeout = parseFloat(document.getElementById('waitTimeout').value) || 1800;
            const cursorSpeed = parseFloat(document.getElementById('cursorSpeed').value) || 0.5;
            const startDelay = parseFloat(document.getElementById('startDelay').value) || 0;

            document.getElementById('loading').classList.add('show');
            document.getElementById('result').className = 'result';
            document.getElementById('progressList').innerHTML = '';

            try {
                const res = await fetch('/api/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ actions, interval, confidence, min_confidence: minConfidence, wait_timeout: waitTimeout, cursor_speed: cursorSpeed, start_delay: startDelay })
                });
                const startResult = await res.json();

                if (startResult.status === 'started') {
                    // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
                    startProgressPolling();
                } else if (res.status === 409) {
                    // æ—¢ã«å®Ÿè¡Œä¸­
                    document.getElementById('loading').classList.remove('show');
                    alert(startResult.detail || 'æ—¢ã«å®Ÿè¡Œä¸­ã§ã™');
                } else {
                    document.getElementById('loading').classList.remove('show');
                    showResult(startResult);
                }
            } catch (e) {
                document.getElementById('loading').classList.remove('show');
                showResult({ success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message, details: [] });
            }
        }

        // é€²æ—ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        function startProgressPolling() {
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(pollExecutionStatus, 500);
        }

        // é€²æ—çŠ¶æ…‹ã‚’å–å¾—
        async function pollExecutionStatus() {
            try {
                const res = await fetch('/api/execute/status');
                const status = await res.json();
                updateProgressDisplay(status);

                if (status.completed || (status.aborted && !status.is_running)) {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    document.getElementById('loading').classList.remove('show');

                    const successCount = status.results.filter(r => r.status === 'success').length;
                    showResult({
                        success: successCount === status.total_steps,
                        message: `${successCount}/${status.total_steps} ä»¶ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã—ã¾ã—ãŸ`,
                        details: status.results
                    });
                }
            } catch (e) {
                console.error('ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', e);
            }
        }

        // é€²æ—è¡¨ç¤ºã‚’æ›´æ–°
        function updateProgressDisplay(status) {
            const progressList = document.getElementById('progressList');
            let html = `<div style="margin-bottom:8px;font-weight:bold;font-size:16px;">é€²æ—: ${status.current_step}/${status.total_steps}</div>`;

            status.results.forEach((r, i) => {
                const icon = r.status === 'success' ? 'âœ…' : r.status === 'aborted' ? 'ğŸ›‘' : 'âŒ';
                const color = r.status === 'success' ? '#28a745' : '#dc3545';
                html += `<div style="color:${color};margin:3px 0;">${i+1}. ${icon} ${escapeHtml(r.message).substring(0, 80)}</div>`;
            });

            if (status.is_running && status.current_step < status.total_steps) {
                html += `<div style="color:#007bff;margin:3px 0;font-weight:bold;">${status.current_step + 1}. â³ å®Ÿè¡Œä¸­...</div>`;
            }

            progressList.innerHTML = html;
        }

        // ä¸­æ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        async function abortExecution() {
            try {
                await fetch('/api/abort', { method: 'POST' });
                const progressList = document.getElementById('progressList');
                progressList.innerHTML += '<div style="color:#dc3545;">ğŸ›‘ ä¸­æ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡...</div>';
            } catch (e) {
                console.error('ä¸­æ­¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—:', e);
            }
        }

        // çµæœè¡¨ç¤º
        function showResult(result) {
            document.getElementById('resultPlaceholder').style.display = 'none';
            document.getElementById('progressList').innerHTML = '';  // é€²æ—ã‚’ã‚¯ãƒªã‚¢
            const container = document.getElementById('result');
            container.className = `result ${result.success ? 'success' : 'error'}`;
            document.getElementById('resultMessage').textContent = result.message;
            document.getElementById('resultDetails').innerHTML = result.details.map(d => {
                const icon = d.status === 'success' ? 'âœ…' : d.status === 'timeout' ? 'â±ï¸' : d.status === 'not_found' ? 'â“' : d.status === 'aborted' ? 'ğŸ›‘' : 'âŒ';
                const itemClass = d.status === 'success' ? 'item-success' : 'item-error';
                // ç”»åƒåã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«ã™ã‚‹ï¼ˆæˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ä¸¡æ–¹ï¼‰
                let messageHtml = escapeHtml(d.message);
                // clipboard_XXX.png ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒªãƒ³ã‚¯åŒ–
                messageHtml = messageHtml.replace(/(clipboard_\d+\.png)/g, (match) => {
                    return `<span class="clickable-image" onclick="showImagePreview('${match}')" style="color:#0066cc;text-decoration:underline;cursor:pointer;">${match}</span>`;
                });
                return `<li class="${itemClass}">${icon} ${messageHtml}</li>`;
            }).join('');
        }

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«
        function showImagePreview(imageName) {
            const img = images.find(x => x.name === imageName);
            if (!img) {
                alert(`ç”»åƒ "${imageName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                return;
            }
            document.getElementById('imagePreviewTitle').textContent = imageName;
            document.getElementById('imagePreviewImg').src = img.path + '?t=' + Date.now();
            document.getElementById('imagePreviewModal').classList.add('show');
        }

        function hideImagePreviewModal() {
            document.getElementById('imagePreviewModal').classList.remove('show');
        }

        // å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰
        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            document.getElementById('deleteToggle').classList.toggle('active', deleteMode);
            document.getElementById('deleteLabel').classList.toggle('active', deleteMode);
            document.getElementById('deleteLabel').textContent = deleteMode ? 'å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ ON' : 'å‰Šé™¤ãƒ¢ãƒ¼ãƒ‰ OFF';
            document.getElementById('imageGrid').classList.toggle('delete-mode', deleteMode);
            renderTexts();
        }

        // ç”»åƒå‰Šé™¤
        async function deleteImage(name) {
            if (!deleteMode || !confirm(`"${name}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            await fetch(`/api/images/${encodeURIComponent(name)}`, { method: 'DELETE' });
            actions = actions.filter(a => a.image_name !== name);
            await loadImages();
            renderActions();
        }

        // ãƒ†ã‚­ã‚¹ãƒˆå‰Šé™¤ï¼ˆIDãƒ™ãƒ¼ã‚¹ï¼‰
        async function deleteText(textId) {
            if (!confirm(`ãƒ†ã‚­ã‚¹ãƒˆ[${textId}]ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            await fetch(`/api/texts/${textId}`, { method: 'DELETE' });
            // ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚­ã‚¹ãƒˆå‚ç…§ã¯ç¶­æŒï¼ˆå®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼‰
            await loadTexts();
            renderActions();
        }

        // ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†ï¼ˆIDãƒ™ãƒ¼ã‚¹ï¼‰
        function editText(textId) {
            editingTextId = textId;
            document.getElementById('textModalTitle').textContent = 'ãƒ†ã‚­ã‚¹ãƒˆç·¨é›†';
            document.getElementById('textInput').value = texts[textId]?.text || '';
            document.getElementById('textModal').classList.add('show');
        }

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«
        function showAddTextModal() {
            editingTextId = null;
            document.getElementById('textModalTitle').textContent = 'ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ ';
            document.getElementById('textInput').value = '';
            document.getElementById('textModal').classList.add('show');
        }

        function hideTextModal() {
            document.getElementById('textModal').classList.remove('show');
        }

        async function saveText() {
            const text = document.getElementById('textInput').value.trim();
            if (!text) { alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            if (editingTextId !== null) {
                await fetch(`/api/texts/${editingTextId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
            } else {
                await fetch('/api/texts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
            }
            hideTextModal();
            await loadTexts();
            renderActions();
        }

        // ãƒ•ãƒ­ãƒ¼ç®¡ç†
        async function loadFlows() {
            const res = await fetch('/api/flows');
            const data = await res.json();
            flows = data.flows;
            renderFlows();
        }

        let selectedFlows = new Set();

        function renderFlows() {
            const list = document.getElementById('flowList');
            const flowNames = Object.keys(flows);
            if (flowNames.length === 0) {
                list.innerHTML = '<p class="empty-message">ãƒ•ãƒ­ãƒ¼ã‚’ä¿å­˜ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>';
                updateSelectedFlowCount();
                return;
            }
            list.innerHTML = flowNames.map(name => {
                const flow = flows[name];
                const actionCount = flow.actions.length;
                const escapedName = escapeHtml(name);
                const isSelected = selectedFlows.has(name);
                return `
                    <div class="flow-item ${isSelected ? 'selected' : ''}">
                        <input type="checkbox" class="flow-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleFlowSelection('${escapedName}', this.checked)">
                        <span class="flow-name" onclick="loadFlow('${escapedName}')" title="ã‚¯ãƒªãƒƒã‚¯ã§èª­ã¿è¾¼ã¿">${escapedName}</span>
                        <span class="flow-meta">${actionCount}ä»¶ | ${flow.created_at || ''}</span>
                        <div class="flow-actions">
                            <button class="load-btn" onclick="loadFlow('${escapedName}')">èª­è¾¼</button>
                            <button class="rename-btn" onclick="showRenameFlowModal('${escapedName}')">åå‰å¤‰æ›´</button>
                            <button class="delete-btn" onclick="deleteFlow('${escapedName}')">å‰Šé™¤</button>
                        </div>
                    </div>
                `;
            }).join('');
            updateSelectedFlowCount();
        }

        function toggleFlowSelection(flowName, isSelected) {
            if (isSelected) {
                selectedFlows.add(flowName);
            } else {
                selectedFlows.delete(flowName);
            }
            renderFlows();
        }

        function updateSelectedFlowCount() {
            const count = selectedFlows.size;
            document.getElementById('selectedFlowCount').textContent = `${count}ä»¶é¸æŠä¸­`;
            document.getElementById('batchHint').style.display = count > 0 ? 'inline' : 'none';
        }

        function showSaveFlowModal() {
            document.getElementById('flowNameInput').value = currentFlowName || '';
            document.getElementById('flowModal').classList.add('show');
            document.getElementById('flowNameInput').focus();
        }

        function hideFlowModal() {
            document.getElementById('flowModal').classList.remove('show');
        }

        async function saveFlow() {
            const name = document.getElementById('flowNameInput').value.trim();
            if (!name) { alert('ãƒ•ãƒ­ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            if (flows[name]) {
                if (!confirm(`"${name}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)) return;
            }

            await fetch('/api/flows', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, actions })
            });
            hideFlowModal();
            await loadFlows();
        }

        function loadFlow(name) {
            const flow = flows[name];
            if (!flow) return;
            actions = JSON.parse(JSON.stringify(flow.actions)); // deep copy
            currentFlowName = name;  // ãƒ•ãƒ­ãƒ¼åã‚’è¨˜æ†¶
            renderActions();
        }

        async function deleteFlow(name) {
            if (!confirm(`ãƒ•ãƒ­ãƒ¼ "${name}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            await fetch(`/api/flows/${encodeURIComponent(name)}`, { method: 'DELETE' });
            await loadFlows();
        }

        // ãƒ•ãƒ­ãƒ¼åå‰å¤‰æ›´
        let renamingFlowName = null;

        function showRenameFlowModal(name) {
            renamingFlowName = name;
            document.getElementById('renameFlowInput').value = name;
            document.getElementById('renameFlowModal').classList.add('show');
            document.getElementById('renameFlowInput').focus();
            document.getElementById('renameFlowInput').select();
        }

        function hideRenameFlowModal() {
            document.getElementById('renameFlowModal').classList.remove('show');
            renamingFlowName = null;
        }

        async function confirmRenameFlow() {
            const newName = document.getElementById('renameFlowInput').value.trim();
            if (!newName) {
                alert('ãƒ•ãƒ­ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            if (newName === renamingFlowName) {
                hideRenameFlowModal();
                return;
            }
            if (flows[newName]) {
                alert(`"${newName}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™`);
                return;
            }

            // æ—§ãƒ•ãƒ­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦æ–°åå‰ã§ä¿å­˜ã€æ—§åå‰ã‚’å‰Šé™¤
            const flowData = flows[renamingFlowName];
            await fetch('/api/flows', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName, actions: flowData.actions })
            });
            await fetch(`/api/flows/${encodeURIComponent(renamingFlowName)}`, { method: 'DELETE' });

            // ç¾åœ¨èª­ã¿è¾¼ã¿ä¸­ã®ãƒ•ãƒ­ãƒ¼åã‚‚æ›´æ–°
            if (currentFlowName === renamingFlowName) {
                currentFlowName = newName;
            }

            hideRenameFlowModal();
            await loadFlows();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        function setupEventListeners() {
            // Escã‚­ãƒ¼ã§ä¸­æ­¢
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    const loading = document.getElementById('loading');
                    if (loading.classList.contains('show')) {
                        abortExecution();
                    }
                }
            });

            document.addEventListener('paste', async e => {
                // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ å†…ã§ã¯ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
                const activeEl = document.activeElement;
                if (activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA')) {
                    return;
                }

                const items = e.clipboardData?.items;
                if (!items) return;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        const blob = item.getAsFile();
                        if (blob) {
                            const ext = item.type.split('/')[1] || 'png';
                            const file = new File([blob], `clipboard_${Date.now()}.${ext}`, { type: item.type });

                            // ç”»åƒä¸€è¦§ã®å·®ã—æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ä¸­
                            if (replacingImageName !== null) {
                                await replaceImage(replacingImageName, file);
                                replacingImageName = null;
                                await loadImages();
                                renderActions();  // ã‚µãƒ ãƒã‚¤ãƒ«æ›´æ–°
                            }
                            // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç”»åƒå·®ã—æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ä¸­
                            else if (swappingImageIndex !== null) {
                                const uploaded = await uploadFiles([file]);
                                if (uploaded && uploaded.length > 0) {
                                    actions[swappingImageIndex].image_name = uploaded[0];
                                    swappingImageIndex = null;
                                    renderActions();
                                }
                            } else {
                                await uploadFiles([file]);
                            }
                        }
                    }
                }
            });
        }

        async function uploadFiles(files) {
            const uploadedNames = [];
            for (const file of files) {
                const formData = new FormData();
                formData.append('file', file);
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                if (res.ok) {
                    const data = await res.json();
                    if (data.filename) uploadedNames.push(data.filename);
                }
            }
            await loadImages();
            return uploadedNames;
        }

        async function replaceImage(imageName, file) {
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch(`/api/images/${encodeURIComponent(imageName)}`, {
                method: 'PUT',
                body: formData
            });
            return res.ok;
        }

        // ãƒ­ã‚°ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
        async function saveLog(logData) {
            try {
                await fetch('/api/log', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ log: logData })
                });
            } catch (e) {
                console.error('ãƒ­ã‚°ä¿å­˜å¤±æ•—:', e);
            }
        }

        // ãƒãƒƒãƒå®Ÿè¡Œ
        async function executeBatchFlows(textId) {
            // ã‚¨ãƒ©ãƒ¼ã‚’å³åº§ã«ã‚µãƒ¼ãƒãƒ¼ã«é€ã‚‹
            const reportError = async (step, error) => {
                const errorLog = `[ERROR] step=${step}\ntextId=${textId}\nselectedFlows=${JSON.stringify(Array.from(selectedFlows))}\nflowsKeys=${JSON.stringify(Object.keys(flows))}\nerror=${error.name}: ${error.message}\nstack=${error.stack}`;
                try {
                    await fetch('/api/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ log: errorLog })
                    });
                } catch (e) { console.error('ãƒ­ã‚°é€ä¿¡å¤±æ•—', e); }
            };

            const logs = [];
            let step = 'init';
            try {
                step = 'timestamp';
                const timestamp = new Date().toISOString();
                logs.push(`[${timestamp}] ãƒãƒƒãƒå®Ÿè¡Œé–‹å§‹`);
                logs.push(`textId: ${textId}`);
                logs.push(`selectedFlows: ${Array.from(selectedFlows).join(', ')}`);

                step = 'flowNames';
                const flowNames = Array.from(selectedFlows);
                if (flowNames.length === 0) {
                    logs.push('ã‚¨ãƒ©ãƒ¼: é¸æŠã•ã‚ŒãŸãƒ•ãƒ­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
                    await saveLog(logs.join('\n'));
                    alert('é¸æŠã•ã‚ŒãŸãƒ•ãƒ­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                step = 'settings';
                const interval = parseFloat(document.getElementById('interval').value) || 2;
                const confidence = parseFloat(document.getElementById('confidence').value) || 0.8;
                const waitTimeout = parseFloat(document.getElementById('waitTimeout').value) || 30;
                const cursorSpeed = parseFloat(document.getElementById('cursorSpeed').value) || 0.5;
                const startDelay = parseFloat(document.getElementById('startDelay').value) || 0;
                logs.push(`è¨­å®š: interval=${interval}, confidence=${confidence}, waitTimeout=${waitTimeout}, cursorSpeed=${cursorSpeed}, startDelay=${startDelay}`);

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            document.getElementById('loading').classList.add('show');
            document.getElementById('result').className = 'result';
            document.getElementById('resultPlaceholder').style.display = 'none';

            step = 'loop_start';
            const allResults = [];

            for (let i = 0; i < flowNames.length; i++) {
                step = `loop_${i}_getFlowName`;
                const flowName = flowNames[i];
                logs.push(`\n--- ãƒ•ãƒ­ãƒ¼ ${i + 1}/${flowNames.length}: ${flowName} ---`);

                step = `loop_${i}_getFlow`;
                const flow = flows[flowName];

                if (!flow) {
                    logs.push(`ã‚¨ãƒ©ãƒ¼: ãƒ•ãƒ­ãƒ¼ "${flowName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
                    logs.push(`åˆ©ç”¨å¯èƒ½ãªãƒ•ãƒ­ãƒ¼: ${Object.keys(flows).join(', ')}`);
                    allResults.push({ flowName, result: { success: false, message: `ãƒ•ãƒ­ãƒ¼ "${flowName}" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, details: [] } });
                    continue;
                }

                step = `loop_${i}_modifyActions`;
                const modifiedActions = flow.actions.map(a => {
                    if (a.type === 'paste') {
                        return { ...a, text_id: textId };
                    }
                    if (a.type === 'save_to_file') {
                        return { ...a, text_id: textId, flow_name: flowName };
                    }
                    return a;
                });
                logs.push(`ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°: ${modifiedActions.length}`);

                try {
                    const res = await fetch('/api/execute', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            actions: modifiedActions,
                            interval,
                            confidence,
                            wait_timeout: waitTimeout,
                            cursor_speed: cursorSpeed,
                            start_delay: startDelay
                        })
                    });
                    const result = await res.json();
                    logs.push(`çµæœ: ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'} - ${result.message}`);
                    if (result.details) {
                        result.details.forEach(d => logs.push(`  - ${typeof d === 'object' ? JSON.stringify(d) : d}`));
                    }
                    allResults.push({ flowName, result });
                } catch (e) {
                    logs.push(`fetchã‚¨ãƒ©ãƒ¼: ${e.message}`);
                    allResults.push({ flowName, result: { success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message, details: [] } });
                }

                if (i < flowNames.length - 1) {
                    await new Promise(r => setTimeout(r, interval * 1000));
                }
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            document.getElementById('loading').classList.remove('show');

            // çµæœé›†è¨ˆ
            const successCount = allResults.filter(r => r.result.success).length;
            logs.push(`\n=== å®Œäº†: ${successCount}/${allResults.length} ä»¶æˆåŠŸ ===`);

            // ãƒ­ã‚°ä¿å­˜
            await saveLog(logs.join('\n'));

            // çµæœè¡¨ç¤º
            const allSuccess = allResults.every(r => r.result.success);
            const container = document.getElementById('result');
            container.className = `result ${allSuccess ? 'success' : 'error'}`;
            document.getElementById('resultMessage').textContent = `ãƒãƒƒãƒå®Ÿè¡Œå®Œäº†: ${successCount}/${allResults.length} ä»¶æˆåŠŸ`;
            document.getElementById('resultDetails').innerHTML = allResults.map(r => {
                const isSuccess = r.result.success;
                const details = r.result.details || [];
                const detailsHtml = details.map(d => {
                    if (typeof d === 'object') {
                        const status = d.success ? 'âœ“' : 'âœ—';
                        return `<div class="${d.success ? 'item-success' : 'item-error'}" style="margin-left:20px;font-size:12px;">${status} ${escapeHtml(d.action || '')} ${escapeHtml(d.message || '')}</div>`;
                    }
                    return `<div style="margin-left:20px;font-size:12px;">${escapeHtml(String(d))}</div>`;
                }).join('');
                return `
                    <li class="${isSuccess ? 'item-success' : 'item-error'}">
                        <strong>${escapeHtml(r.flowName)}</strong>: ${r.result.message}
                        ${detailsHtml}
                    </li>
                `;
            }).join('');

            // é¸æŠã‚’ã‚¯ãƒªã‚¢
            selectedFlows.clear();
            renderFlows();
            } catch (e) {
                await reportError(step, e);
                document.getElementById('loading').classList.remove('show');
                throw e; // å‘¼ã³å‡ºã—å…ƒã®catchã«æ¸¡ã™
            }
        }
    </script>
</body>
</html>
